name: Publish to npm

on:
  push:
    branches: [main]

concurrency:
  group: publish
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    # Skip version-bump commits to prevent infinite loops
    if: "!startsWith(github.event.head_commit.message, 'chore: release v')"
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org
          cache: npm
          cache-dependency-path: |
            package-lock.json
            src/dashboard/package-lock.json

      - name: Determine version bump
        id: bump
        run: |
          # Find commits since last version tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --oneline --format="%s")
          else
            COMMITS=$(git log "$LAST_TAG"..HEAD --oneline --format="%s")
          fi

          if [ -z "$COMMITS" ]; then
            echo "type=none" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Commits since $LAST_TAG:"
          echo "$COMMITS"

          # Check for breaking changes
          if echo "$COMMITS" | grep -qiE 'BREAKING CHANGE|^[a-z]+!:'; then
            echo "type=major" >> "$GITHUB_OUTPUT"
          elif echo "$COMMITS" | grep -qE '^feat(\(.+\))?:'; then
            echo "type=minor" >> "$GITHUB_OUTPUT"
          else
            echo "type=patch" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump version
        if: steps.bump.outputs.type != 'none'
        id: version
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          NEW_VERSION=$(npm version ${{ steps.bump.outputs.type }} --no-git-tag-version)
          echo "new=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "Bumped to $NEW_VERSION (${{ steps.bump.outputs.type }})"

      - name: Install dependencies
        if: steps.bump.outputs.type != 'none'
        run: |
          npm ci
          cd src/dashboard && npm ci

      - name: Build
        if: steps.bump.outputs.type != 'none'
        run: |
          npm run build:cli
          npm run build:dashboard

      - name: Publish
        if: steps.bump.outputs.type != 'none'
        id: publish
        run: |
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "::error::NPM_TOKEN secret is not set. Add it in repo Settings â†’ Secrets â†’ Actions."
            exit 1
          fi

          # Check if this version already exists on npm (idempotent re-runs)
          PKG_NAME=$(node -p "require('./package.json').name")
          PKG_VERSION=$(node -p "require('./package.json').version")
          if npm view "${PKG_NAME}@${PKG_VERSION}" version 2>/dev/null; then
            echo "â­ï¸ ${PKG_NAME}@${PKG_VERSION} already published â€” skipping"
            echo "skipped=true" >> "$GITHUB_OUTPUT"
          else
            npm publish --ignore-scripts --access public
            echo "skipped=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Commit version bump & tag
        if: steps.bump.outputs.type != 'none'
        run: |
          git add package.json package-lock.json
          git commit -m "chore: release ${{ steps.version.outputs.new }}"
          git tag "${{ steps.version.outputs.new }}"
          git push origin main --follow-tags

      - name: Create GitHub Release
        if: steps.bump.outputs.type != 'none'
        run: |
          # Check if release already exists (idempotent re-runs)
          if gh release view "${{ steps.version.outputs.new }}" &>/dev/null; then
            echo "â­ï¸ Release ${{ steps.version.outputs.new }} already exists â€” skipping"
          else
            # Brief delay to ensure the tag is available on the remote
            sleep 5
            gh release create "${{ steps.version.outputs.new }}" \
              --title "${{ steps.version.outputs.new }}" \
              --generate-notes \
              --target main
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          if [ "${{ steps.bump.outputs.type }}" != "none" ]; then
            echo "ðŸ“¦ Published opencastle@${{ steps.version.outputs.new }} (${{ steps.bump.outputs.type }} bump)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "â­ï¸ No new commits since last release â€” skipped" >> "$GITHUB_STEP_SUMMARY"
          fi
